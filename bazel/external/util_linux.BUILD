# TODO: these definitions are from the generated config.h. Edit to be a
# minimal working set.

UTIL_LINUX_DEFINES = [
        "-DAGETTY_RELOAD=1",
        "-DCHFN_CHSH_PASSWORD=1",
        "-DENABLE_NLS=1",
        '-DFS_SEARCH_PATH=\\"/sbin:/sbin/fs.d:/sbin/fs\\"',
        "-DHAVE_BTRFS_SUPPORT=1",
        "-DHAVE_BYTESWAP_H=1",
        "-DHAVE_CLEARENV=1",
        "-DHAVE_CLOCK_GETTIME=1",
        "-DHAVE_CPU_SET_T=1",
        "-DHAVE_CRYPT_H=1",
        "-DHAVE_DCGETTEXT=1",
        "-DHAVE_DECL_CPU_ALLOC=1",
        "-DHAVE_DIRFD=1",
        "-DHAVE_DLFCN_H=1",
        "-DHAVE_EACCESS=1",
        "-DHAVE_ENDIAN_H=1",
        "-DHAVE_ENVIRON_DECL=1",
        "-DHAVE_ERR=1",
        "-DHAVE_ERRNO_H=1",
        "-DHAVE_ERRX=1",
        "-DHAVE_ERR_H=1",
        "-DHAVE_EXPLICIT_BZERO=1",
        "-DHAVE_FALLOCATE=1",
        "-DHAVE_FCNTL_H=1",
        "-DHAVE_FSEEKO=1",
        "-DHAVE_FSTATAT=1",
        "-DHAVE_FSYNC=1",
        "-DHAVE_FUTIMENS=1",
        "-DHAVE_GETDOMAINNAME=1",
        "-DHAVE_GETDTABLESIZE=1",
        "-DHAVE_GETOPT_H=1",
        "-DHAVE_GETRANDOM=1",
        "-DHAVE_GETRLIMIT=1",
        "-DHAVE_GETSGNAM=1",
        "-DHAVE_GETTEXT=1",
        "-DHAVE_GETUSERSHELL=1",
        "-DHAVE_INOTIFY_INIT=1",
        "-DHAVE_INOTIFY_INIT1=1",
        "-DHAVE_INTTYPES_H=1",
        "-DHAVE_IOPERM=1",
        "-DHAVE_IOPL=1",
        "-DHAVE_ISNAN=1",
        "-DHAVE_JRAND48=1",
        "-DHAVE_LANGINFO_ALTMON=1",
        "-DHAVE_LANGINFO_H=1",
        "-DHAVE_LANGINFO_NL_ABALTMON=1",
        "-DHAVE_LASTLOG_H=1",
        "-DHAVE_LCHOWN=1",
        "-DHAVE_LIBBLKID=1",
        "-DHAVE_LIBCRYPT=1",
        "-DHAVE_LIBMOUNT=1",
        "-DHAVE_LIBSYSTEMD=1",
        "-DHAVE_LIBUDEV=1",
        "-DHAVE_LINUX_BLKPG_H=1",
        "-DHAVE_LINUX_BLKZONED_H=1",
        "-DHAVE_LINUX_BTRFS_H=1",
        "-DHAVE_LINUX_CDROM_H=1",
        "-DHAVE_LINUX_FALLOC_H=1",
        "-DHAVE_LINUX_FD_H=1",
        "-DHAVE_LINUX_GSMMUX_H=1",
        "-DHAVE_LINUX_MAJOR_H=1",
        "-DHAVE_LINUX_NET_NAMESPACE_H=1",
        "-DHAVE_LINUX_RAW_H=1",
        "-DHAVE_LINUX_SECUREBITS_H=1",
        "-DHAVE_LINUX_TIOCL_H=1",
        "-DHAVE_LINUX_VERSION_H=1",
        "-DHAVE_LINUX_WATCHDOG_H=1",
        "-DHAVE_LOCALE_H=1",
        "-DHAVE_LOFF_T=1",
        "-DHAVE_LSEEK64=1",
        "-DHAVE_LSEEK64_PROTOTYPE=1",
        "-DHAVE_MEMORY_H=1",
        "-DHAVE_MEMPCPY=1",
        "-DHAVE_MKOSTEMP=1",
        "-DHAVE_MNTENT_H=1",
        "-DHAVE_NANOSLEEP=1",
        "-DHAVE_NETINET_IN_H=1",
        "-DHAVE_NET_IF_H=1",
        "-DHAVE_NTP_GETTIME=1",
        "-DHAVE_OPENAT=1",
        "-DHAVE_OPEN_MEMSTREAM=1",
        "-DHAVE_PATHS_H=1",
        "-DHAVE_PERSONALITY=1",
        "-DHAVE_POSIX_FADVISE=1",
        "-DHAVE_POSIX_FALLOCATE=1",
        "-DHAVE_PRCTL=1",
        "-DHAVE_PRLIMIT=1",
        "-DHAVE_PROGRAM_INVOCATION_SHORT_NAME=1",
        "-DHAVE_PTY_H=1",
        "-DHAVE_QSORT_R=1",
        "-DHAVE_REBOOT=1",
        "-DHAVE_RPMATCH=1",
        "-DHAVE_SCANDIRAT=1",
        "-DHAVE_SCANF_MS_MODIFIER=1",
        "-DHAVE_SCHED_SETSCHEDULER=1",
        "-DHAVE_SECURE_GETENV=1",
        "-DHAVE_SECURITY_PAM_APPL_H=1",
        "-DHAVE_SECURITY_PAM_MISC_H=1",
        "-DHAVE_SETNS=1",
        "-DHAVE_SETRESGID=1",
        "-DHAVE_SETRESUID=1",
        "-DHAVE_SHADOW_H=1",
        "-DHAVE_SIGHANDLER_T=1",
        "-DHAVE_SIGQUEUE=1",
        "-DHAVE_SRANDOM=1",
        "-DHAVE_STDINT_H=1",
        "-DHAVE_STDIO_EXT_H=1",
        "-DHAVE_STDLIB_H=1",
        "-DHAVE_STRINGS_H=1",
        "-DHAVE_STRING_H=1",
        "-DHAVE_STRNDUP=1",
        "-DHAVE_STRNLEN=1",
        "-DHAVE_STRSIGNAL_DECL=1",
        "-DHAVE_STRUCT_STAT_ST_MTIM_TV_NSEC=1",
        "-DHAVE_STRUCT_TERMIOS_C_LINE=1",
        "-DHAVE_STRUCT_TM_TM_ZONE=1",
        "-DHAVE_SWAPOFF=1",
        "-DHAVE_SWAPON=1",
        "-DHAVE_SYSCONF=1",
        "-DHAVE_SYSINFO=1",
        "-DHAVE_SYS_FILE_H=1",
        "-DHAVE_SYS_IOCTL_H=1",
        "-DHAVE_SYS_IO_H=1",
        "-DHAVE_SYS_MOUNT_H=1",
        "-DHAVE_SYS_PARAM_H=1",
        "-DHAVE_SYS_PRCTL_H=1",
        "-DHAVE_SYS_RESOURCE_H=1",
        "-DHAVE_SYS_SIGNALFD_H=1",
        "-DHAVE_SYS_SOCKET_H=1",
        "-DHAVE_SYS_STAT_H=1",
        "-DHAVE_SYS_SWAP_H=1",
        "-DHAVE_SYS_SYSCALL_H=1",
        "-DHAVE_SYS_SYSMACROS_H=1",
        "-DHAVE_SYS_TIMEX_H=1",
        "-DHAVE_SYS_TIME_H=1",
        "-DHAVE_SYS_TTYDEFAULTS_H=1",
        "-DHAVE_SYS_TYPES_H=1",
        "-DHAVE_SYS_UN_H=1",
        "-DHAVE_TIMEGM=1",
        "-DHAVE_TLS=1",
        "-DHAVE_TM_GMTOFF=1",
        "-DHAVE_TM_ZONE=1",
        "-DHAVE_UNISTD_H=1",
        "-DHAVE_UNSHARE=1",
        "-DHAVE_UPDWTMPX=1",
        "-DHAVE_USLEEP=1",
        "-DHAVE_UTIMENSAT=1",
        "-DHAVE_UTMPX_H=1",
        "-DHAVE_UTMP_H=1",
        "-DHAVE_UUIDD=1",
        "-DHAVE_VWARNX=1",
        "-DHAVE_WARN=1",
        "-DHAVE_WARNX=1",
        "-DHAVE_WIDECHAR=1",
        "-DHAVE___FPENDING=1",
        "-DHAVE___FPURGE=1",
        "-DHAVE___PROGNAME=1",
        '-DLIBBLKID_DATE=\\"06-Nov-2018\\"',
        '-DLIBBLKID_VERSION=\\"2.33.0\\"',
        '-DLIBFDISK_VERSION=\\"2.33.0\\"',
        '-DLIBMOUNT_VERSION=\\"2.33.0\\"',
        '-DLIBSMARTCOLS_VERSION=\\"2.33.0\\"',
        '-DLT_OBJDIR=\\".libs/\\"',
        "-DONLY_LISTED_SHELLS=1",
        '-DPACKAGE=\\"util-linux\\"',
        '-DPACKAGE_BUGREPORT=\\"kzak@redhat.com\\"',
        '-DPACKAGE_NAME=\\"util-linux\\"',
        '-DPACKAGE_STRING=\\"util-linux=2.33\\"',
        '-DPACKAGE_TARNAME=\\"util-linux\\"',
        '-DPACKAGE_URL=\\"http://www.kernel.org/pub/linux/utils/util-linux/\\"',
        '-DPACKAGE_VERSION=\\"2.33\\"',
        "-DPG_BELL=1",
        "-DSTDC_HEADERS=1",
        "-DUSE_LIBMOUNT_SUPPORT_NAMESPACES=1",
        "-D_GNU_SOURCE=1",
        ]

UTIL_LINUX_COPTS = [
        "-I external/org_kernel_util_linux/libmount/src",
        "-I external/org_kernel_util_linux/libblkid/src",
        "-I external/org_kernel_util_linux/include",
        "-I $(GENDIR)/external/org_kernel_util_linux",
        ]

genrule(
        name = "headers",
        srcs = glob([ "configure", "sys-utils/mount.c", "install.sh", "config/*", "*.in", "**/*.in" ]),
        outs = ["blkid.h", "libmount.h", "config.h"],
        cmd = "pushd $$(dirname $(location configure)) \
                && ./configure \
                && popd \
                && mkdir -p $$(dirname $(location blkid.h)) \
                && cp $$(dirname $(location configure))/libblkid/src/blkid.h $(location blkid.h) \
                && cp $$(dirname $(location configure))/libmount/src/libmount.h $(location libmount.h) \
                && touch $(location config.h)",
                )

cc_library(
        name = "blkid",
        srcs = glob(["libblkid/src/*.c", "libblkid/src/*.h", "include/*.h"]) + [":blkid.h"],
        copts = UTIL_LINUX_COPTS + UTIL_LINUX_DEFINES,
        hdrs = glob([
            "libblk.h",
        ]),
        )

cc_library(
        name = "mount",
        srcs = glob(["libmount/src/*.c", "libmount/src/*.h", "lib/*.c" ]) + [":libmount.h", ":blkid.h", ":config.h"],
        copts = UTIL_LINUX_COPTS + UTIL_LINUX_DEFINES,
        visibility = ["//visibility:public"],
        includes = ["."],
        hdrs = [ "libmount.h" ],
        deps = [ ":blkid" ],
        )

